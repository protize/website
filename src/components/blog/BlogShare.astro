---
import {
  Share2,
  X,
  MessageCircle,
  Facebook,
  Twitter,
  Linkedin,
  Instagram,
  Send,
  Copy,
} from "lucide-react";

type Props = {
  title: string;
  url?: string;
  id?: string;
};

const { title, url: passedUrl, id } = Astro.props as Props;

const url = passedUrl ?? Astro.url.href;
const encodedURL = encodeURIComponent(url);
const encodedTitle = encodeURIComponent(title);

const shareItems = [
  {
    key: "whatsapp",
    label: "WhatsApp",
    href: `https://wa.me/?text=${encodedTitle}%20${encodedURL}`,
    icon: MessageCircle,
  },
  {
    key: "facebook",
    label: "Facebook",
    href: `https://www.facebook.com/sharer/sharer.php?u=${encodedURL}`,
    icon: Facebook,
  },
  {
    key: "twitter",
    label: "X",
    href: `https://x.com/intent/tweet?text=${encodedTitle}&url=${encodedURL}`,
    icon: Twitter,
  },
  {
    key: "linkedin",
    label: "LinkedIn",
    href: `https://www.linkedin.com/sharing/share-offsite/?url=${encodedURL}`,
    icon: Linkedin,
  },
  {
    key: "instagram",
    label: "Instagram",
    href: `https://www.instagram.com/`,
    icon: Instagram,
  },
];

const uid = id ?? `share-${Math.random().toString(36).slice(2, 9)}`;

const ids = {
  btn: `${uid}-btn`,
  modal: `${uid}-modal`,
  overlay: `${uid}-overlay`,
  close: `${uid}-close`,
  copy: `${uid}-copy`,
  native: `${uid}-native`,
};
---

<div class="relative">
  <button
    id={ids.btn}
    class="inline-flex items-center gap-2 rounded-lg border border-primary/20 px-3 py-1.5 text-sm font-medium text-primary hover:bg-primary/10 transition"
    aria-haspopup="dialog"
    aria-controls={ids.modal}
    aria-expanded="false"
    type="button"
  >
    <Share2 className="h-4 w-4" />
    Share
  </button>

  <div
    id={ids.modal}
    class="fixed inset-0 z-50 hidden"
    role="dialog"
    aria-modal="true"
    aria-label="Share dialog"
  >
    <button
      id={ids.overlay}
      class="absolute inset-0 bg-black/50"
      aria-label="Close share dialog"
      type="button"></button>

    <div
      class="absolute inset-x-4 top-16 mx-auto max-w-sm rounded-2xl bg-white p-5 shadow-xl"
    >
      <div class="mb-4 flex items-center justify-between">
        <h2 class="text-sm font-semibold text-primary">Share this post</h2>
        <button
          id={ids.close}
          class="p-1 rounded hover:bg-primary/10 text-primary transition"
          aria-label="Close"
          type="button"
        >
          <X className="h-5 w-5" />
        </button>
      </div>

      <div class="grid grid-cols-5 gap-3 text-center">
        {
          shareItems.map((item) => {
            const Icon = item.icon;
            return (
              <a
                href={item.href}
                target="_blank"
                rel="noopener noreferrer"
                class="group flex flex-col items-center gap-1 rounded-lg p-2 hover:bg-primary/10 transition"
                aria-label={`Share on ${item.label}`}
                title={`Share on ${item.label}`}
              >
                <Icon className="h-6 w-6 text-primary group-hover:opacity-80" />
                <span class="text-[11px] text-primary/80">{item.label}</span>
              </a>
            );
          })
        }
      </div>

      <div class="mt-5 flex items-center justify-between gap-3">
        <button
          id={ids.native}
          class="flex-1 inline-flex items-center justify-center gap-2 rounded-lg border border-primary/20 px-3 py-2 text-sm font-medium text-primary hover:bg-primary/10 transition"
          type="button"
        >
          <Send className="h-4 w-4" />
          Share via device
        </button>

        <button
          id={ids.copy}
          class="flex-1 inline-flex items-center justify-center gap-2 rounded-lg border border-primary/20 px-3 py-2 text-sm font-medium text-primary hover:bg-primary/10 transition"
          type="button"
        >
          <Copy className="h-4 w-4" />
          Copy link
        </button>
      </div>
    </div>
  </div>
</div>

<script define:vars={{ ids, url, title }}>
  (() => {
    const modal = document.getElementById(ids.modal);
    const openBtn = document.getElementById(ids.btn);
    const closeBtn = document.getElementById(ids.close);
    const overlay = document.getElementById(ids.overlay);
    const copyBtn = document.getElementById(ids.copy);
    const nativeBtn = document.getElementById(ids.native);

    if (!modal || !openBtn || !closeBtn || !overlay || !copyBtn || !nativeBtn)
      return;

    function openModal() {
      modal.classList.remove("hidden");
      openBtn.setAttribute("aria-expanded", "true");
      document.body.classList.add("overflow-hidden");
    }

    function closeModal() {
      modal.classList.add("hidden");
      openBtn.setAttribute("aria-expanded", "false");
      document.body.classList.remove("overflow-hidden");
    }

    openBtn.addEventListener("click", openModal);
    closeBtn.addEventListener("click", closeModal);
    overlay.addEventListener("click", closeModal);

    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") closeModal();
    });

    nativeBtn.addEventListener("click", async () => {
      if (navigator.share) {
        try {
          await navigator.share({ title, url });
          closeModal();
        } catch {
          // ignore cancel
        }
      } else {
        alert("Sharing not supported on this device.");
      }
    });

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(url);
        const prev = copyBtn.textContent;
        copyBtn.textContent = "Copied!";
        setTimeout(() => (copyBtn.textContent = prev || "Copy link"), 1200);
      } catch {
        alert("Unable to copy link.");
      }
    });
  })();
</script>
