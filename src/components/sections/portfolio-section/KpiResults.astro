---
const kpis = [
  { value: "100+", label: "Engineers Enabled Across Programs" },
  { value: "50M+", label: "Monthly Page Views Supported" },
  { value: "Up to 70%", label: "Faster Delivery Cycles" },
  { value: "99.9%", label: "Reliability Targets Supported" },
  { value: "$1M+", label: "Opportunity Savings Unlocked" },
  { value: "Up to 2x", label: "Conversion Uplift on Key Journeys" },
];
---

<section id="kpi" class="relative overflow-hidden">
  <div class="mx-auto max-w-7xl px-6 py-20 md:py-24">
    <div class="mb-12 md:mb-14 text-center">
      <p class="text-sm font-semibold uppercase tracking-[0.2em] text-blue-700">
        KPI / Results
      </p>

      <h2 class="mt-3 text-3xl font-bold leading-tight md:text-5xl">
        Measurable Outcomes
      </h2>

      <p class="mt-4 max-w-2xl mx-auto text-base text-gray-800 md:text-lg">
        We focus on engineering outcomes tied to performance, reliability,
        speed, and business value.
      </p>
    </div>

    <div class="grid gap-5 sm:grid-cols-2 lg:grid-cols-3">
      {
        kpis.map((k, i) => (
          <article
            class="kpi-card group relative overflow-hidden rounded-2xl border border-white/10 bg-white/[0.04] p-6 backdrop-blur-xl transition-all duration-500 hover:-translate-y-1 hover:border-blue-700/30 hover:bg-white/[0.06] hover:shadow-[0_12px_40px_-12px_rgba(56,189,248,0.35)]"
            style={`--delay:${i * 90}ms`}
          >
            <div class="absolute inset-x-0 top-0 h-px bg-gradient-to-r from-transparent via-blue-700/60 to-transparent" />

            <div class="pointer-events-none absolute -left-1/2 top-0 h-full w-1/2 -skew-x-12 bg-gradient-to-r from-transparent via-white/10 to-transparent opacity-0 transition duration-700 group-hover:left-[120%] group-hover:opacity-100" />

            <p
              class="kpi-value text-3xl font-bold tracking-tight text-blue-700 md:text-4xl"
              data-target={k.value}
            >
              {k.value}
            </p>
            <p class="mt-2 text-sm leading-relaxed text-gray-800 md:text-base">
              {k.label}
            </p>
          </article>
        ))
      }
    </div>
  </div>
</section>

<script is:inline>
  (function () {
    const cards = document.querySelectorAll(".kpi-card");

    function parseKpi(value) {
      const raw = (value || "").trim();

      // Up to 70% / Up to 2x
      const upToMatch = raw.match(/^Up to\s+([\d.]+)\s*([%x])$/i);
      if (upToMatch) {
        const numText = upToMatch[1];
        return {
          prefix: "Up to ",
          number: Number(numText),
          suffix: upToMatch[2],
          decimals: numText.includes(".") ? numText.split(".")[1].length : 0,
          plus: false,
        };
      }

      // $1M+
      const moneyMMatch = raw.match(/^\$([\d.]+)M\+$/i);
      if (moneyMMatch) {
        const numText = moneyMMatch[1];
        return {
          prefix: "$",
          number: Number(numText),
          suffix: "M",
          decimals: numText.includes(".") ? numText.split(".")[1].length : 0,
          plus: true,
        };
      }

      // 50M+
      const mMatch = raw.match(/^([\d.]+)M\+$/i);
      if (mMatch) {
        const numText = mMatch[1];
        return {
          prefix: "",
          number: Number(numText),
          suffix: "M",
          decimals: numText.includes(".") ? numText.split(".")[1].length : 0,
          plus: true,
        };
      }

      // 99.9%
      const pctMatch = raw.match(/^([\d.]+)%$/);
      if (pctMatch) {
        const numText = pctMatch[1];
        return {
          prefix: "",
          number: Number(numText),
          suffix: "%",
          decimals: numText.includes(".") ? numText.split(".")[1].length : 0,
          plus: false,
        };
      }

      // 100+
      const plusMatch = raw.match(/^([\d.]+)\+$/);
      if (plusMatch) {
        const numText = plusMatch[1];
        return {
          prefix: "",
          number: Number(numText),
          suffix: "",
          decimals: numText.includes(".") ? numText.split(".")[1].length : 0,
          plus: true,
        };
      }

      // fallback
      const n = Number(raw.replace(/[^\d.]/g, "")) || 0;
      return { prefix: "", number: n, suffix: "", decimals: 0, plus: false };
    }

    function formatKpi(cfg, current) {
      const fixed =
        cfg.decimals > 0
          ? current.toFixed(cfg.decimals)
          : Math.round(current).toString();

      return `${cfg.prefix}${fixed}${cfg.suffix}${cfg.plus ? "+" : ""}`;
    }

    function animateCount(el, targetText, duration = 1400) {
      const cfg = parseKpi(targetText);
      const start = performance.now();

      function tick(now) {
        const progress = Math.min((now - start) / duration, 1);
        const eased = 1 - Math.pow(1 - progress, 3);
        const value = cfg.number * eased;

        el.textContent = formatKpi(cfg, value);

        if (progress < 1) {
          requestAnimationFrame(tick);
        } else {
          el.textContent = targetText; // exact final value
        }
      }

      requestAnimationFrame(tick);
    }

    const observer = new IntersectionObserver(
      (entries, obs) => {
        entries.forEach((entry) => {
          if (!entry.isIntersecting) return;

          const card = entry.target;
          const valueEl = card.querySelector(".kpi-value");
          const delayRaw = card.style.getPropertyValue("--delay") || "0ms";
          const delay = parseInt(delayRaw, 10) || 0;

          card.animate(
            [
              { opacity: 0, transform: "translateY(18px) scale(0.98)" },
              { opacity: 1, transform: "translateY(0) scale(1)" },
            ],
            {
              duration: 700,
              delay,
              easing: "cubic-bezier(0.16, 1, 0.3, 1)",
              fill: "forwards",
            },
          );

          if (valueEl) {
            const finalText =
              valueEl.getAttribute("data-target") || valueEl.textContent || "";
            valueEl.textContent = "0";
            setTimeout(() => animateCount(valueEl, finalText), delay);
          }

          obs.unobserve(card);
        });
      },
      { threshold: 0.25 },
    );

    cards.forEach((card) => {
      card.style.opacity = "0";
      card.style.transform = "translateY(18px) scale(0.98)";
      observer.observe(card);
    });
  })();
</script>
