---
import type { CollectionEntry } from "astro:content";

type Props = {
  posts: CollectionEntry<"portfolio">[];
};

const { posts = [] } = Astro.props as Props;

const formatDate = (d: Date) =>
  new Date(d).toLocaleDateString("en-IN", {
    year: "numeric",
    month: "short",
    day: "numeric",
  });
---

<section class="relative" aria-label="Case study projects slideshow">
  <!-- Controls -->
  <div class="mb-4 flex items-center justify-end gap-2">
    <button
      id="portfolio-prev"
      type="button"
      class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-300 bg-white text-neutral-700 transition hover:bg-neutral-50 disabled:cursor-not-allowed disabled:opacity-40"
      aria-label="Previous"
    >
      <span aria-hidden="true">←</span>
    </button>

    <button
      id="portfolio-next"
      type="button"
      class="inline-flex h-10 w-10 items-center justify-center rounded-full border border-neutral-300 bg-white text-neutral-700 transition hover:bg-neutral-50 disabled:cursor-not-allowed disabled:opacity-40"
      aria-label="Next"
    >
      <span aria-hidden="true">→</span>
    </button>
  </div>

  <!-- Slider viewport -->
  <div
    id="portfolio-slider"
    class="relative overflow-hidden outline-none"
    tabindex="0"
    aria-label="Portfolio slider"
  >
    <div
      id="portfolio-track"
      class="flex touch-pan-y transition-transform duration-500 ease-out"
      role="list"
      aria-label="Case study projects"
    >
      {
        posts.map((post) => {
          const { title, excerpt, pubDate, logo, coverAlt, tags = [] } = post.data;

          const href = `/portfolio/${post.slug}`;
          const tagsAttr = tags
            .map((t) => String(t).trim().toLowerCase())
            .filter(Boolean)
            .join(",");

          return (
            <article
              role="listitem"
              data-tags={tagsAttr}
              class="group shrink-0 basis-full px-2 sm:basis-1/2 lg:basis-1/4"
            >
              <a
                href={href}
                aria-label={`Read case study: ${title}`}
                class="relative block overflow-hidden rounded-2xl border border-neutral-200 bg-white shadow-sm transition hover:shadow-md focus:outline-none focus-visible:ring-2 focus-visible:ring-neutral-400"
              >
                <!-- Square logo area -->
                <div class="relative aspect-square w-full overflow-hidden bg-neutral-100">
                  {logo ? (
                    <img
                      src={logo}
                      alt={coverAlt ?? title}
                      class="h-full w-full object-cover transition duration-500 group-hover:scale-105 group-focus-visible:scale-105"
                      loading="lazy"
                      decoding="async"
                    />
                  ) : (
                    <div class="flex h-full w-full items-center justify-center text-neutral-400">
                      <span class="text-sm">No logo</span>
                    </div>
                  )}

                  <!-- dark layer -->
                  <div class="pointer-events-none absolute inset-0 bg-black/10 transition duration-300 group-hover:backdrop-blur-sm group-hover:bg-black/70 group-focus-visible:bg-black/70" />

                  <!-- initial badge -->
                  <div class="pointer-events-none absolute inset-0 flex items-end p-4 transition duration-300 group-hover:opacity-0 group-focus-visible:opacity-0">
                    <div class="rounded-lg bg-white/85 px-3 py-1.5 text-xs font-medium text-neutral-800 backdrop-blur">
                      View Case Study
                    </div>
                  </div>

                  <!-- Hover/Foucs overlay content -->
                  <div class="absolute inset-0 flex translate-y-6 flex-col justify-end p-4 text-white opacity-0 transition-all duration-300 group-hover:translate-y-0 group-hover:opacity-100 group-focus-visible:translate-y-0 group-focus-visible:opacity-100">
                    <h3 class="line-clamp-2 text-base font-semibold leading-snug sm:text-lg">
                      {title}
                    </h3>

                    {excerpt && (
                      <p class="mt-2 line-clamp-3 text-xs text-white/90">
                        {excerpt}
                      </p>
                    )}

                    <div class="mt-3 text-xs text-white/85 sm:text-sm">
                      {formatDate(pubDate)}
                    </div>

                    {tags.length > 0 && (
                      <div class="mt-3 flex flex-wrap gap-2">
                        {tags.slice(0, 4).map((t) => (
                          <span class="inline-flex items-center rounded-full border border-white/35 bg-white/10 px-2.5 py-1 text-[10px] text-white/95 backdrop-blur">
                            {t}
                          </span>
                        ))}
                      </div>
                    )}
                  </div>
                </div>
              </a>
            </article>
          );
        })
      }
    </div>
  </div>

  <!-- Dots -->
  <div
    id="portfolio-dots"
    class="mt-4 flex items-center justify-center gap-2"
    aria-label="Slide indicators"
  />
</section>

<script is:inline>
  (() => {
    const slider = document.getElementById("portfolio-slider");
    const track = document.getElementById("portfolio-track");
    const prevBtn = document.getElementById("portfolio-prev");
    const nextBtn = document.getElementById("portfolio-next");
    const dotsWrap = document.getElementById("portfolio-dots");

    if (!slider || !track || !prevBtn || !nextBtn || !dotsWrap) return;

    const allCards = Array.from(track.querySelectorAll("article[data-tags]"));

    let current = 0; // index of first visible card
    let visibleCards = [...allCards];
    let perView = getPerView();
    let maxIndex = getMaxIndex();

    // autoplay config
    const AUTOPLAY_MS = 3000;
    let autoplayId = null;
    let userPaused = false;

    function getPerView() {
      const w = window.innerWidth;
      if (w >= 1024) return 3; // desktop
      if (w >= 640) return 2; // tablet
      return 1; // mobile
    }

    function getCardOuterWidth() {
      const first = visibleCards[0];
      if (!first) return slider.clientWidth;
      return first.getBoundingClientRect().width;
    }

    function getMaxIndex() {
      return Math.max(visibleCards.length - perView, 0);
    }

    function loopIndex(index) {
      if (maxIndex <= 0) return 0;
      if (index > maxIndex) return 0;
      if (index < 0) return maxIndex;
      return index;
    }

    function updateControls() {
      const noMove = maxIndex <= 0;
      prevBtn.disabled = noMove;
      nextBtn.disabled = noMove;
    }

    function renderDots() {
      const totalSteps = maxIndex + 1;
      dotsWrap.innerHTML = "";

      for (let i = 0; i < totalSteps; i++) {
        const dot = document.createElement("button");
        dot.type = "button";
        dot.className =
          "h-2.5 w-2.5 rounded-full transition " +
          (i === current ? "bg-neutral-800" : "bg-neutral-300 hover:bg-neutral-400");
        dot.setAttribute("aria-label", `Go to position ${i + 1}`);
        dot.addEventListener("click", () => {
          current = i;
          update();
          restartAutoplay();
        });
        dotsWrap.appendChild(dot);
      }
    }

    function update() {
      perView = getPerView();
      maxIndex = getMaxIndex();
      current = loopIndex(current);

      const cardW = getCardOuterWidth();
      const x = -(current * cardW);
      track.style.transform = `translate3d(${x}px,0,0)`;

      updateControls();
      renderDots();
    }

    function collectVisibleCards() {
      visibleCards = allCards.filter((el) => !el.classList.contains("hidden"));
      perView = getPerView();
      maxIndex = getMaxIndex();
      current = loopIndex(current);
    }

    function applyFilter(tag) {
      const needle = (tag || "*").toLowerCase();

      allCards.forEach((el) => {
        const tags = (el.getAttribute("data-tags") || "")
          .split(",")
          .map((s) => s.trim())
          .filter(Boolean);

        const show = needle === "*" || tags.includes(needle);
        el.classList.toggle("hidden", !show);
      });

      collectVisibleCards();
      update();
      restartAutoplay();
    }

    function nextOne() {
      current += 1; // one card at a time
      update();
    }

    function prevOne() {
      current -= 1; // one card at a time
      update();
    }

    function startAutoplay() {
      stopAutoplay();
      if (maxIndex <= 0 || userPaused) return;
      autoplayId = window.setInterval(() => {
        nextOne();
      }, AUTOPLAY_MS);
    }

    function stopAutoplay() {
      if (autoplayId) {
        clearInterval(autoplayId);
        autoplayId = null;
      }
    }

    function restartAutoplay() {
      startAutoplay();
    }

    // controls
    prevBtn.addEventListener("click", () => {
      prevOne();
      restartAutoplay();
    });

    nextBtn.addEventListener("click", () => {
      nextOne();
      restartAutoplay();
    });

    // keyboard
    slider.addEventListener("keydown", (e) => {
      if (e.key === "ArrowLeft") {
        prevOne();
        restartAutoplay();
      } else if (e.key === "ArrowRight") {
        nextOne();
        restartAutoplay();
      }
    });

    // pause/resume on hover
    slider.addEventListener("mouseenter", () => {
      userPaused = true;
      stopAutoplay();
    });

    slider.addEventListener("mouseleave", () => {
      userPaused = false;
      startAutoplay();
    });

    // extra pause/resume on track hover
    track.addEventListener("mouseenter", () => {
      userPaused = true;
      stopAutoplay();
    });

    track.addEventListener("mouseleave", () => {
      userPaused = false;
      startAutoplay();
    });

    // touch swipe
    let startX = 0;
    let deltaX = 0;
    let dragging = false;

    slider.addEventListener(
      "touchstart",
      (e) => {
        userPaused = true;
        stopAutoplay();

        dragging = true;
        startX = e.touches[0].clientX;
        deltaX = 0;
      },
      { passive: true }
    );

    slider.addEventListener(
      "touchmove",
      (e) => {
        if (!dragging) return;
        deltaX = e.touches[0].clientX - startX;
      },
      { passive: true }
    );

    slider.addEventListener("touchend", () => {
      if (!dragging) return;
      dragging = false;

      const threshold = 50;
      if (deltaX > threshold) prevOne();
      else if (deltaX < -threshold) nextOne();

      userPaused = false;
      startAutoplay();
    });

    // filter events
    const onFilter = (e) => {
      const tag = e?.detail?.tag || "*";
      current = 0;
      applyFilter(tag);
    };

    slider.addEventListener("protize:filter-change", onFilter);
    document.addEventListener("protize:filter-change", onFilter);

    // stop when tab hidden
    document.addEventListener("visibilitychange", () => {
      if (document.hidden) stopAutoplay();
      else startAutoplay();
    });

    // init from ?tag=
    const initialTag = (
      new URL(window.location.href).searchParams.get("tag") || "*"
    ).toLowerCase();

    window.addEventListener("resize", () => {
      update();
      restartAutoplay();
    });

    applyFilter(initialTag);
    startAutoplay();
  })();
</script>
