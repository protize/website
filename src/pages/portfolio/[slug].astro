---
import Layout from "../../layouts/Layout.astro";
import FadeIn from "../../components/animations/FadeIn";
import { getCollection } from "astro:content";
import ProjectCard from "../../components/portfolio/ProjectCard.astro";
import CTASection from "../../components/home/CTASection.astro";

export async function getStaticPaths() {
  const portfolioEntries = await getCollection("portfolio");
  return portfolioEntries.map((entry) => ({
    params: { slug: entry.slug },
    props: { entry },
  }));
}

const { entry } = Astro.props;
const { Content } = await entry.render();
const project = entry.data;

// Get related projects (same category, excluding current)
const allProjects = await getCollection("portfolio");
const relatedProjects = allProjects
  .filter(
    (p) =>
      p.data.category?.trim() === project.category?.trim() &&
      p.slug !== entry.slug,
  )
  .sort(
    (a, b) => new Date(b.data.date).getTime() - new Date(a.data.date).getTime(),
  )
  .slice(0, 3)
  .map((p) => ({
    id: p.id,
    slug: p.slug,
    ...p.data,
  }));
---

<Layout title={project.title}>
  <section class="py-10 md:py-20">
    <div class="container-custom">
      <FadeIn client:load direction="up">
        <div class="grid lg:grid-cols-2 gap-16 items-center">
          <!-- LEFT CONTENT -->
          <div>
            <span
              class="inline-flex items-center px-4 py-2 bg-primary/10 text-primary rounded-full text-sm font-semibold mb-6"
            >
              {project.category}
            </span>

            <h1
              class="text-3xl md:text-4xl font-heading font-bold text-navy leading-tight mb-6"
            >
              {project.title}
            </h1>

            <p
              class="text-base lg:text-lg text-gray-600 mb-10 leading-relaxed max-w-xl"
            >
              {project.shortDescription}
            </p>

            <!-- Info Grid -->
            <div class="grid grid-cols-2 sm:grid-cols-4 gap-6 mb-10">
              <div>
                <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">
                  Client
                </p>
                <p class="font-semibold text-navy">{project.client}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">
                  Date
                </p>
                <p class="font-semibold text-navy">
                  {
                    new Date(project.date).toLocaleDateString("en-US", {
                      month: "long",
                      year: "numeric",
                    })
                  }
                </p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">
                  Duration
                </p>
                <p class="font-semibold text-navy">{project.duration}</p>
              </div>
              <div>
                <p class="text-xs uppercase tracking-wide text-gray-400 mb-1">
                  Team
                </p>
                <p class="font-semibold text-navy">
                  {project.teamSize} members
                </p>
              </div>
            </div>

            <!-- Buttons -->
            <div class="flex flex-wrap gap-4">
              {
                project.liveUrl && (
                  <a
                    href={project.liveUrl}
                    target="_blank"
                    rel="noopener noreferrer"
                    class="btn-primary"
                  >
                    View Live Site
                  </a>
                )
              }
              <a href="/contact-us" class="btn-primary">
                Start Similar Project
              </a>
            </div>
          </div>

          <!-- RIGHT IMAGE -->
          <div class="relative">
            <img
              src={project.featuredImage}
              alt={project.title}
              class="rounded-3xl w-[70%] object-cover"
            />
          </div>
        </div>
      </FadeIn>
    </div>

    <div class="container-custom mt-20">
      <FadeIn client:load direction="up"
        >``
        <div class="max-w-5xl mx-auto space-y-10">
          <!-- Challenge -->
          <div class="">
            <h2 class="text-3xl font-heading font-bold text-navy mb-6">
              The Challenge
            </h2>
            <p class="text-lg text-gray-700 leading-relaxed">
              {project.challenge}
            </p>
          </div>

          <!-- Solution -->
          <div class="">
            <h2 class="text-3xl font-heading font-bold text-navy mb-6">
              Our Solution
            </h2>
            <p class="text-lg text-gray-700 leading-relaxed">
              {project.solution}
            </p>
          </div>
        </div>
        <div class="max-w-5xl mx-auto space-y-10 mt-10">
          <h3 class="text-2xl font-heading font-bold mb-6 text-navy">
            Technologies Used
          </h3>

          <div class="flex flex-wrap gap-3">
            {
              project.technologies.map((tech) => (
                <span class="px-4 py-2 bg-white border border-gray-200 rounded-full text-sm font-medium shadow-sm hover:bg-primary hover:text-white hover:border-primary transition">
                  {tech}
                </span>
              ))
            }
          </div>
        </div>
      </FadeIn>
    </div>

    <!-- Markdown Content -->
    <div class="max-w-5xl mx-auto px-4">
      <div
        class="leading-8 space-y-6 [&>h2]:mt-10 [&>h2]:text-2xl [&>h2]:font-bold [&>h3]:mt-8 [&>h3]:text-xl [&>p]:text-[17px] [&>ul]:list-disc [&>ul]:pl-6 [&>ol]:list-decimal [&>ol]:pl-6 [&>a]:underline [&_code]:bg-[#24292E] [&_code]:text-white [&_code]:px-1.5 [&_code]:py-0.5 [&_code]:rounded [&_pre]:bg-gray-900 [&_pre]:text-white [&_pre]:p-4 [&_pre]:rounded-xl [&_img]:rounded-xl"
      >
        <Content />
      </div>
    </div>
  </section>

  <!-- Related Projects -->
  {
    relatedProjects.length > 0 && (
      <section class="section-padding bg-white">
        <div class="container-custom">
          <FadeIn client:load direction="up">
            <div class="text-center mb-12">
              <h2 class="text-3xl md:text-4xl font-heading font-bold mb-4">
                Related <span class="gradient-text">Projects</span>
              </h2>
              <p class="text-gray-600">
                Explore more {project.category} projects
              </p>
            </div>

            <div class="grid md:grid-cols-3 gap-8">
              {relatedProjects.map((relatedProject) => (
                <ProjectCard project={relatedProject} />
              ))}
            </div>

            <div class="text-center mt-12">
              <a href="/portfolio" class="btn-primary">
                View All Projects
              </a>
            </div>
          </FadeIn>
        </div>
      </section>
    )
  }

  <!-- CTA Section -->
  <CTASection
    title="Let's Build Something Amazing Together"
    subtitle="Ready to start your project? We're here to help you achieve your goals."
    actions={[
      {
        label: "Our Services",
        href: "/services",
        variant: "primary",
        icon: true,
      },
    ]}
  />
</Layout>
