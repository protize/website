---
import FadeIn from "../../components/animations/FadeIn";
import BlogShare from "../../components/blog/BlogShare.astro";
import Layout from "../../layouts/Layout.astro";
import { getCollection, render } from "astro:content";

const formatDate = (dateLike: any) =>
  new Date(dateLike).toLocaleDateString("en-US", {
    month: "short",
    day: "2-digit",
    year: "numeric",
  });

export async function getStaticPaths() {
  const posts = (await getCollection("blog"))
    .filter((p) => !p.data.draft)
    .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));

  return posts.map((post) => ({
    params: { slug: post.id },
    props: post,
  }));
}

const post = Astro.props;
const { Content } = await render(post);

const {
  title,
  description,
  author,
  pubDate,
  updatedDate,
  tags = [],
  category,
  featured,
  coverImage,
  coverAlt,
  backUrl = "blog",
} = post.data ?? {};
---

<Layout title={title ?? "Blog"}>
  <FadeIn client:load direction="up">
    <article class="mx-auto max-w-5xl px-6 py-8 sm:py-12">
      <div class="mb-6">
        <a
          href={`/${backUrl}`}
          class="inline-flex items-center gap-2 text-sm text-primary hover:text-primary/90 capitalize"
        >
          <span aria-hidden>←</span> Back to {backUrl}
        </a>
      </div>

      {
        coverImage && (
          <img
            src={coverImage}
            alt={coverAlt ?? title}
            class="w-full rounded-2xl mb-8 shadow-sm border border-gray-100"
            loading="lazy"
          />
        )
      }

      <header class="mb-8">
        <div class="flex items-center justify-between gap-4">
          <div class="mb-3 flex flex-wrap items-center gap-2">
            {
              category && (
                <span class="inline-flex items-center rounded-full border border-gray-200 bg-white px-3 py-1 text-xs font-semibold text-gray-700">
                  {category}
                </span>
              )
            }

            {
              featured && (
                <span class="inline-flex items-center rounded-full bg-primary px-3 py-1 text-xs font-semibold text-white">
                  Featured
                </span>
              )
            }
          </div>

          <BlogShare title={title} />
        </div>

        <h1
          class="text-2xl sm:text-4xl font-extrabold tracking-tight text-gray-900 leading-tight"
        >
          {title}
        </h1>

        {
          description && (
            <p class="mt-3 text-base text-gray-600">{description}</p>
          )
        }

        <div
          class="mt-4 flex flex-wrap items-center gap-x-3 gap-y-2 text-sm text-gray-500"
        >
          {author && <span class="font-medium text-gray-700">{author}</span>}

          {
            author && pubDate && (
              <span aria-hidden class="text-gray-300">
                •
              </span>
            )
          }

          {
            pubDate && (
              <time datetime={new Date(pubDate).toISOString()}>
                {formatDate(pubDate)}
              </time>
            )
          }

          {
            updatedDate && (
              <>
                <span aria-hidden class="text-gray-300">
                  •
                </span>
                <span>
                  Updated{" "}
                  <time datetime={new Date(updatedDate).toISOString()}>
                    {formatDate(updatedDate)}
                  </time>
                </span>
              </>
            )
          }
        </div>

        {
          tags.length > 0 && (
            <div class="mt-5 flex flex-wrap gap-2">
              {tags.map((t: string) => (
                <span class="text-xs font-medium bg-purple-50 text-primary px-3 py-1 rounded-full border border-purple-200">
                  #{t}
                </span>
              ))}
            </div>
          )
        }
      </header>

      <hr class="border-gray-200 mb-8" />

      <div
        class="leading-8 space-y-6
      [&>h2]:mt-10 [&>h2]:text-2xl [&>h2]:font-bold
      [&>h3]:mt-8 [&>h3]:text-xl
      [&>p]:text-[17px]
      [&>ul]:list-disc [&>ul]:pl-6
      [&>ol]:list-decimal [&>ol]:pl-6
      [&>a]:underline
      [&_code]:bg-[#24292E] [&_code]:text-white [&_code]:px-1.5 [&_code]:py-0.5 [&_code]:rounded
      [&_pre]:bg-gray-900 [&_pre]:text-white [&_pre]:p-4 [&_pre]:rounded-xl
      [&_img]:rounded-xl"
      >
        <Content />
      </div>

      <div
        class="mt-12 pt-6 border-t border-gray-200 flex items-center justify-between text-sm"
      >
        <a
          href={`/${backUrl}`}
          class="inline-flex items-center gap-2 text-primary hover:text-primary/90 capitalize"
        >
          <span aria-hidden>←</span> Back to {backUrl}
        </a>
      </div>
    </article>
  </FadeIn>
</Layout>
