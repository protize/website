---
import BlogHero from "../../../components/shared/BlogHero.astro";
import BlogPagination from "../../../components/shared/BlogPagination.astro";
import Container from "../../../components/shared/Container.astro";
import Layout from "../../../layouts/Layout.astro";
import { getCollection } from "astro:content";

const PAGE_SIZE = 6;

const formatDate = (date: Date) =>
  new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "2-digit",
    year: "numeric",
  });

export async function getStaticPaths() {
  const PAGE_SIZE = 6;
  const posts = (await getCollection("blog")).filter((p) => !p.data.draft);
  const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
  const paths = [];

  for (let i = 2; i <= totalPages; i++) {
    paths.push({ params: { page: String(i) } });
  }

  return paths;
}

const { page } = Astro.params;
const currentPage = Math.max(2, parseInt(page || "2", 10));

const posts = (await getCollection("blog"))
  .filter((p) => !p.data.draft)
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));

const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));

if (currentPage > totalPages) {
  throw new Error(`Page ${currentPage} out of range (${totalPages})`);
}

const start = (currentPage - 1) * PAGE_SIZE;
const end = start + PAGE_SIZE;
const pagePosts = posts.slice(start, end);

const subtitles = [
  "Exploring ideas, innovations, and engineering practices that power the digital future.",
  "Guides and Portfolio to help you build, deploy, and scale with confidence.",
  "The builder’s corner—where innovation meets implementation.",
  "Turning complex technology into simple, actionable insights.",
  "Where code meets creativity—notes from the Protize team.",
];

const subtitle = subtitles[Math.floor(Math.random() * subtitles.length)];
---

<Layout title={`Blog — Page ${currentPage}`}>
  <Container className="space-y-10 py-10">
    <!-- Hero -->
    <div class="pb-10">
      <BlogHero title="Protize Stories" subtitle={subtitle} />
    </div>

    <!-- Blog Grid -->
    <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
      {
        pagePosts.map(({ data, slug }) => (
          <a
            href={`/blog/${slug}`}
            class="group block rounded-2xl overflow-hidden border border-gray-200 hover:border-purple-300 hover:shadow-lg transition-all duration-200 bg-white"
          >
            {data.coverImage && (
              <img
                src={data.coverImage}
                alt={data.coverAlt ?? data.title}
                class="h-52 w-full object-cover group-hover:opacity-90 transition-opacity duration-200"
                loading="lazy"
              />
            )}
            <div class="p-5">
              <h2 class="text-lg font-semibold text-gray-800 group-hover:text-purple-600 transition-colors">
                {data.title}
              </h2>
              <p class="text-sm text-gray-500 mt-1">
                {formatDate(data.pubDate)}
              </p>

              {data.description && (
                <p class="mt-2 text-sm text-gray-600 leading-relaxed line-clamp-3">
                  {data.description}
                </p>
              )}

              {data.tags?.length > 0 && (
                <div class="mt-3 flex flex-wrap gap-2">
                  {data.tags.slice(0, 3).map((t) => (
                    <span class="text-xs bg-purple-50 text-purple-700 px-2.5 py-1 rounded-full border border-purple-100">
                      {t}
                    </span>
                  ))}
                </div>
              )}
            </div>
          </a>
        ))
      }
    </div>

    <!-- Pagination -->
    <div class="pt-8">
      <BlogPagination currentPage={currentPage} totalPages={totalPages} />
    </div>
  </Container>
</Layout>
