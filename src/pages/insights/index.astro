---
import Container from "../../components/shared/Container.astro";
import Layout from "../../layouts/Layout.astro";
import { getCollection } from "astro:content";
import BlogHero from "../../components/shared/BlogHero.astro";
import BlogPagination from "../../components/shared/BlogPagination.astro";

const PAGE_SIZE = 6;

const formatDate = (date: Date) =>
  new Date(date).toLocaleDateString("en-US", {
    month: "short",
    day: "2-digit",
    year: "numeric",
  });

const raw = await getCollection("insights");
console.log("RAW COUNT", raw.length);
console.log(
  raw.map((p) => ({ slug: p.slug, draft: p.data.draft, title: p.data.title })),
);

const allPosts = raw
  .filter((p) => !p.data.draft)
  .sort((a, b) => +new Date(b.data.pubDate) - +new Date(a.data.pubDate));

console.log("PUBLISHED COUNT", allPosts.length);

const featuredPost = allPosts.find((p) => p.data.featured === true) ?? null;

const posts = featuredPost
  ? allPosts.filter((p) => p.id !== featuredPost.id)
  : allPosts;

const currentPage = 1;
const totalPages = Math.max(1, Math.ceil(posts.length / PAGE_SIZE));
const pagePosts = posts.slice(0, PAGE_SIZE);

const subtitles = [
  "Exploring ideas, innovations, and engineering practices that power the digital future.",
  "Guides and Portfolio to help you build, deploy, and scale with confidence.",
  "The builder’s corner—where innovation meets implementation.",
  "Turning complex technology into simple, actionable insights.",
  "Where code meets creativity—notes from the Protize team.",
];

const subtitle = subtitles[Math.floor(Math.random() * subtitles.length)];
---

<Layout title="Insights">
  <Container className="space-y-10 py-10">
    <!-- Hero Section -->
    <div class="pb-6">
      <BlogHero title="Protize Insights" subtitle={subtitle} />
    </div>

    <!-- Featured Posts Section -->
    {
      featuredPost && (
        <>
          {(() => {
            const d = featuredPost.data;
            return (
              <section class="mb-10">
                <a
                  href={`/insights/${featuredPost.slug}`}
                  class="block rounded-3xl border border-gray-200 bg-white p-4 sm:p-6 md:p-7 shadow-sm hover:shadow-md transition-shadow duration-200"
                >
                  <div class="grid gap-6 md:grid-cols-[300px,1fr] lg:grid-cols-[360px,1fr] items-start">
                    {d.coverImage && (
                      <img
                        src={d.coverImage}
                        alt={d.coverAlt ?? d.title}
                        class="w-full h-52 sm:h-60 md:h-64 object-cover rounded-2xl"
                        loading="lazy"
                      />
                    )}

                    <div class="flex flex-col">
                      <span class="inline-flex w-fit items-center rounded-full bg-orange-50 px-3 py-1 text-[11px] font-semibold uppercase tracking-wide text-orange-600 ring-1 ring-orange-200">
                        Featured
                      </span>

                      <h2 class="mt-3 text-2xl lg:text-3xl font-extrabold leading-tight text-gray-900">
                        {d.title}
                      </h2>

                      {d.description && (
                        <p class="mt-3 text-gray-600 text-[15px] sm:text-base leading-relaxed">
                          {d.description}
                        </p>
                      )}

                      <div class="mt-4 flex flex-wrap items-center gap-2 text-sm text-gray-500">
                        <time datetime={new Date(d.pubDate).toISOString()}>
                          {formatDate(d.pubDate)}
                        </time>
                        {d.author && (
                          <>
                            <span class="text-gray-300">•</span>
                            <span class="font-medium text-gray-700">
                              {d.author}
                            </span>
                          </>
                        )}
                      </div>

                      {d.tags?.length > 0 && (
                        <div class="mt-3 flex flex-wrap gap-2">
                          {d.tags.slice(0, 4).map((t) => (
                            <span class="inline-flex items-center rounded-full border border-purple-100 bg-purple-50 px-2.5 py-1 text-xs font-medium text-purple-700">
                              {t}
                            </span>
                          ))}
                        </div>
                      )}
                    </div>
                  </div>
                </a>
              </section>
            );
          })()}
        </>
      )
    }

    <!-- Blog Cards -->
    {
      pagePosts.length === 0 ? (
        <p class="text-center text-gray-600">No posts yet.</p>
      ) : (
        <div class="grid sm:grid-cols-2 lg:grid-cols-3 gap-8">
          {pagePosts.map(({ data, slug }) => (
            <a
              href={`/blog/${slug}`}
              class="group block rounded-2xl overflow-hidden border border-gray-200 hover:border-purple-300 hover:shadow-lg transition-all duration-200 bg-white"
            >
              {data.coverImage && (
                <img
                  src={data.coverImage}
                  alt={data.coverAlt ?? data.title}
                  class="h-52 w-full object-cover group-hover:opacity-90 transition-opacity duration-200"
                  loading="lazy"
                />
              )}
              <div class="p-5">
                <h2 class="text-lg font-semibold text-gray-800 group-hover:text-purple-600 transition-colors">
                  {data.title}
                </h2>
                <p class="text-sm text-gray-500 mt-1">
                  {formatDate(data.pubDate)}
                </p>

                {data.description && (
                  <p class="mt-2 text-sm text-gray-600 leading-relaxed line-clamp-3">
                    {data.description}
                  </p>
                )}

                {data.tags?.length > 0 && (
                  <div class="mt-3 flex flex-wrap gap-2">
                    {data.tags.slice(0, 3).map((t) => (
                      <span class="text-xs bg-purple-50 text-purple-700 px-2.5 py-1 rounded-full border border-purple-100">
                        {t}
                      </span>
                    ))}
                  </div>
                )}
              </div>
            </a>
          ))}
        </div>
      )
    }

    <!-- Pagination -->
    <div class="pt-8">
      <BlogPagination currentPage={currentPage} totalPages={totalPages} />
    </div>
  </Container>
</Layout>
